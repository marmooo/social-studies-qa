import{BarController,BarElement,CategoryScale,Chart,Filler,Legend,LinearScale,LineController,LineElement,PointElement,RadarController,RadialLinearScale,}from"https://cdn.jsdelivr.net/npm/chart.js@4.5.0/+esm";Chart.register(BarController,BarElement,CategoryScale,Filler,Legend,LinearScale,LineController,LineElement,PointElement,RadarController,RadialLinearScale);const charts={};let totalTrials=100;const eras=["縄文","弥生","古墳","飛鳥","奈良","平安","鎌倉","室町","南北朝","戦国","安土桃山","江戸","幕末","明治","大正","昭和","先史","古代","中世","近世","近代","現代"],categoryToSubject={"世界":"世界地理","アジア":"世界地理","ヨーロッパ":"世界地理","アフリカ":"世界地理","北アメリカ":"世界地理","南アメリカ":"世界地理","オセアニア":"日本地理","日本":"日本地理","北海道":"日本地理","東北":"日本地理","関東":"日本地理","中部":"日本地理","近畿":"日本地理","中国・四国":"日本地理","九州":"日本地理","縄文":"日本史","弥生":"日本史","古墳":"日本史","飛鳥":"日本史","奈良":"日本史","平安":"日本史","鎌倉":"日本史","室町":"日本史","南北朝":"日本史","戦国":"日本史","安土桃山":"日本史","江戸":"日本史","幕末":"日本史","明治":"日本史","大正":"日本史","昭和":"日本史","先史":"世界史","古代":"世界史","中世":"世界史","近世":"世界史","近代":"世界史","現代":"世界史","現代社会":"公民","法":"公民","政治":"公民","経済":"公民"},subjectIds=["japanGeographyWords","worldGeographyWords","japanHistoryWords","japanHistoryPersons","worldHistoryWords","worldHistoryPersons","civicsWords"],subjectDict={"日本地理語句":0,"世界地理語句":1,"日本史語句":2,"日本史人物":3,"世界史語句":4,"世界史人物":5,"公民語句":6},allProblems=[];let problems=[],incorrect=!1,firstRun=!0,audioContext;const audioBufferCache={};loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function createAudioContext(){return globalThis.AudioContext?new globalThis.AudioContext:(console.error("Web Audio API is not supported in this browser"),null)}function unlockAudio(){audioContext?audioContext.resume():(audioContext=createAudioContext(),loadAudio("error","mp3/cat.mp3"),loadAudio("correct","mp3/correct3.mp3"),loadAudio("incorrect","mp3/incorrect1.mp3")),document.removeEventListener("pointerdown",unlockAudio),document.removeEventListener("keydown",unlockAudio)}async function loadAudio(e,t){if(!audioContext)return;if(audioBufferCache[e])return audioBufferCache[e];try{const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}catch(t){throw console.error(`Loading audio ${e} error:`,t),t}}function playAudio(e,t){if(!audioContext)return;const o=audioBufferCache[e];if(!o){console.error(`Audio ${e} is not found in cache`);return}const n=audioContext.createBufferSource();n.buffer=o;const s=audioContext.createGain();t&&(s.gain.value=t),s.connect(audioContext.destination),n.connect(s),n.start()}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}function shuffle(e){for(let t=e.length;1<t;t--){const n=Math.floor(Math.random()*t);[e[n],e[t-1]]=[e[t-1],e[n]]}return e}function getErasInRange(e){if(!e.includes("〜"))return eras.includes(e)?[e]:[];const[s,o]=e.split("〜"),t=eras.indexOf(s),n=eras.indexOf(o);if(t===-1||n===-1)return[];if(t<=n)return eras.slice(t,n+1)}function getCategories(e){const t=[];return e.split("｜").forEach(e=>{const n=getErasInRange(e);t.push(...n)}),t.length===0?[e]:t}async function fetchProblems(){const e=["data/地理語句.csv","data/歴史語句.csv","data/歴史人物.csv","data/公民語句.csv"],t=await Promise.all(e.map(e=>fetch(e))),n=await Promise.all(t.map(e=>e.text()));n.forEach((e,t)=>{t===2?e.trimEnd().split(`
`).forEach(e=>{const[t,n,s,o]=e.split(","),i=getCategories(s);i.forEach(e=>{const s=categoryToSubject[e]+"人物",i=`${t} (${n})`,a={subject:s,answer:i,category:e,sentence:o};allProblems.push(a)})}):e.trimEnd().split(`
`).forEach(e=>{const[t,n,s,o]=e.split(","),i=getCategories(n);i.forEach(e=>{const n=categoryToSubject[e]+"語句",i=o.split(" "),a={subject:n,answer:t,category:e,sentence:s,choices:i};allProblems.push(a)})})})}function getQuestionScope(){const e=new Set,t=document.getElementById("questionScope"),n=t.querySelectorAll(":checked");for(const t of n){const s=t.parentNode.parentNode.parentNode.firstElementChild.dataset.subject,o=t.parentNode.textContent.trimEnd();e.add(`${s}:${o}`)}return e}function initRadarData(){const t=new Array(7),e=new Array(7);for(let t=0;t<7;t++)e[t]=getRandomInt(0,100);return{labels:[["日本地理","語句"],["世界地理","語句"],["日本史","語句"],["日本史","人物"],["世界史","語句"],["世界史","人物"],["公民","語句"]],datasets:[{label:"平均点",data:e,counts:t,fill:!0}]}}function initLineData(){const e=[],t=[],n=Array.from({length:totalTrials},(e,t)=>t+1);for(let n=0;n<totalTrials;n++){const s=Math.random()<.5?1:0;e.push(s);const o=e.reduce((e,t)=>e+t,0),i=o/e.length*100;t.push(i)}return{labels:n,datasets:[{label:"平均点",data:t,pointRadius:0,pointHoverRadius:0}]}}function clearRadarChart(){const e=charts.radar.data.datasets[0];for(let t=0;t<e.data.length;t++)e.data[t]=0,e.counts[t]=0}function clearLineChart(){const e=charts.line;e.data.labels=[],e.data.datasets[0].data=[]}function clearBarCharts(){for(let e=0;e<subjectIds.length;e++){const n=charts[subjectIds[e]],t=n.data.datasets[0];for(let e=0;e<t.data.length;e++)t.data[e]=0,t.counts[e]=0}}function updateRadarChart(e,t){const o=t?0:1,n=charts.radar.data.datasets[0],s=subjectDict[e.subject],i=n.data[s]*n.counts[s]/100;n.counts[s]+=1,n.data[s]=(i+o)/n.counts[s]*100,charts.radar.update()}function updateLineChart(e){const s=e?0:1,t=charts.line.data.labels.length+1,n=charts.line.data.datasets[0].data;if(charts.line.data.labels.push(t),t===1)n.push(s/t)*100;else{const e=(n.at(-1)*(t-1)+s)/t;n.push(e)}charts.line.update()}function updateBarCharts(e,t){const l=t?0:1,i=subjectDict[e.subject],d=subjectIds[i],u=document.querySelectorAll("#questionScope > details"),o=u[i].querySelectorAll("label"),a=new Array(o.length);for(let e=0;e<o.length;e++)a[e]=o[e].textContent.trimEnd();const n=a.findIndex(t=>t===e.category)-1,r=charts[d],s=r.data.datasets[0],c=s.counts[n]+1,h=(s.data[n]*(c-1)+l)/c;s.data[n]=h,s.counts[n]+=1,r.update()}function updateChart(e,t){totalTrials+=1,updateRadarChart(e,t),updateLineChart(t),updateBarCharts(e,t)}function addSolvedProblems(e){const t=document.getElementById("solvedProblems"),n=`<tr><td>${e.subject}</td><td>${e.category}</td><td>${e.answer}</td><td>${e.sentence}</td></tr>`;t.insertAdjacentHTML("beforeend",n)}function setProblem(){incorrect=!1;const t=problems[getRandomInt(0,problems.length)];document.getElementById("problem").textContent=t.sentence;const n=document.getElementById("choices").querySelectorAll("button"),e=Array.from(n);if(shuffle(e),e[0].textContent=t.answer,e[0].onclick=()=>{incorrect&&addSolvedProblems(t),updateChart(t,incorrect),e[0].textConent=`⭕ ${e[0].textContent}`,playAudio("correct"),setProblem()},t.subject.endsWith("人物")){const n=problems.filter(e=>t.subject===e.subject);for(let t=1;t<4;t++){const o=getRandomInt(0,n.length),i=n[o],s=i.answer;e[t].textContent=s,e[t].onclick=()=>{incorrect=!0,e[t].textContent=`❌ ${s}`,playAudio("incorrect")}}}else{const n=Array.from({length:t.choices.length},(e,t)=>t);shuffle(n);for(let s=0;s<3;s++){const o=t.choices[n[s]];e[s+1].textContent=o,e[s+1].onclick=()=>{incorrect=!0,e[s+1].textContent=`❌ ${o}`,playAudio("incorrect")}}}}function setSelectAllEvents(){const e=document.querySelectorAll("#questionScope > details");for(const n of e){const t=n.querySelectorAll("div"),s=t[0].querySelector("input");s.addEventListener("change",e=>{if(e.currentTarget.checked)for(let e=1;e<t.length;e++)t[e].querySelector("input").checked=!0;else for(let e=1;e<t.length;e++)t[e].querySelector("input").checked=!1})}}function startGame(){firstRun&&(firstRun=!1,totalTrials=0,clearRadarChart(),clearLineChart(),clearBarCharts());const e=getQuestionScope();problems=[],allProblems.forEach(t=>{e.has(`${t.subject}:${t.category}`)&&problems.push(t)}),setProblem()}function initCharts(){initRadarChart(),initLineChart(),initBarCharts()}function initBarCharts(){const e=document.querySelectorAll("#questionScope > details");for(let t=0;t<e.length;t++){const n=Array.from(e[t].querySelectorAll("label")).slice(1).map(e=>e.textContent.trimEnd()),s=new Array(n.length);for(let e=0;e<n.length;e++)s[e]=Math.random()*100;const o={labels:n,datasets:[{axis:"y",label:"平均点",data:s,counts:new Array(n.length)}]};initBarChart(subjectIds[t],o)}}function initRadarChart(){const e=document.getElementById("radar"),t=new Chart(e,{type:"radar",data:initRadarData(),options:{scales:{r:{min:0,max:100,pointLabels:{font:{size:16}}}},plugins:{legend:{display:!1},tooltip:{enabled:!1}},elements:{line:{borderWidth:3}}}});charts.radar=t}function initLineChart(){const e=document.getElementById("line"),t=new Chart(e,{type:"line",data:initLineData(),options:{plugins:{legend:{display:!1},tooltip:{enabled:!1}}}});charts.line=t}function initBarChart(e,t){const n=document.getElementById(e),s=new Chart(n,{type:"bar",data:t,options:{indexAxis:"y",plugins:{legend:{display:!1},tooltip:{enabled:!1}}}});charts[e]=s}await fetchProblems(),setSelectAllEvents(),initCharts(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("startButton").onclick=startGame,document.addEventListener("pointerdown",unlockAudio,{once:!0}),document.addEventListener("keydown",unlockAudio,{once:!0})